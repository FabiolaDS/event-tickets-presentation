@page "/events/{eventId:long}/checkout"
@inject IEventService _eventService
@inject ITicketService _ticketService
@inject ICreditCardService _creditCardService
@inject IPaymentService _paymentService
@inject NavigationManager _navigationManager
@inject AuthenticationStateProvider _authenticationStateProvider
@using eventTicketPesentation.Shared.Components.Preloader

@* @using BlazorWizard *@
@using eventTicketPesentation.Shared.Components.NavMenu
@using eventTicketPesentation.Shared.Components.Wizard
@using eventTicketPesentation.Service
@using eventTicketPesentation.Models
@using eventTicketPesentation.Service.dto
<NavMenu/>
<section class="section">
    <h1 class="text-center">@_event.Name</h1>
    <div class="container">

        <Wizard Id="Checkout" Submit="@Submit">
            <WizardStep Name="1. Nr. of tickets">

                <p class="text-center text-black-50 font-weight-bold">@_event.DateTime.Date.ToShortDateString() | @_event.DateTime.TimeOfDay.Hours pm</p>
                <div class="row justify-content-center" style="padding-top: 20px">
                    <div class="col-md-10 col-md-offset-1">
                        <table class="step1-table">
                            <thead>
                            <tr>
                                <td >Available</td>
                                <td>Price</td>
                                <td>Quantity</td>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>@_event.NrOfTickets</td>

                                <td>
                                    <div>@_event.Price</div>
                                </td>
                                <td>
                                    @* <input class="ticket-quantity" type="number" min="1" max="5"/> *@
                                    <div class="ticket_counter clearfix">
                                        <div class="spinner">
                                            <button class="decrease" @onclick="DecrementCount">-</button><input type="text" min="1" value="@_ticketDto.nrOfTickets" class="count_ticket value"><button @onclick="IncrementCount" class="increase">+</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="container">

                        <div class="total">

                            <div class="left">Total</div>
                            <div class="right">@TotalPrice()</div>
                        </div>
                    </div>
                </div>
            </WizardStep>
            @* <WizardStep Name="2. Personal Data"> *@
            @* *@
            @*     <EditForm Model="@_user"> *@
            @* *@
            @*         <div class="form__group"> *@
            @* *@
            @*             <label >Email address</label> *@
            @*             <InputText type="email" placeholder="email" @bind-Value="@_user.email"/> *@
            @*         </div> *@
            @* *@
            @*         <div class="form__group"> *@
            @*             <label >Full Name</label> *@
            @*             <InputText type="text" placeholder="full name" @bind-Value="@_user.fullName"/> *@
            @*         </div> *@
            @*         <DataAnnotationsValidator/> *@
            @*         <ValidationSummary/> *@
            @*     </EditForm> *@
            @* *@
            @* </WizardStep> *@


            <WizardStep Name="2. Payment">
                <div class="col-md-10 mx-auto">
                    <div class="row justify-content-around">
                        <div class="col-md-4">
                            <h2 class="mb-4">Your booking:</h2>
                            <p> Nr. of tickets: <span>@_ticketDto.nrOfTickets</span></p>
                            <p>Final price: <span>@TotalPrice()</span> </p>
                        </div>

                        @if (_rememberedCreditCards == null)
                        {
                            <Preloader/>
                        }
                        else
                        {
                            <div>
                                <select value="..." @onchange="@ChangeCreditCard">
                                    @foreach (var card in _rememberedCreditCards)
                                    {
                                        <option value="@card.CardNumber">@card.CardNumber</option>
                                    }
                                </select>
                            </div>
                        }
                        <div class="col-md-6">
                            <h2 class="mb-4">Card Details</h2>
                            <EditForm Model="_creditCard">
                                <div class="form__group">

                                    <label >Card Owner</label>
                                    <InputText type="text" placeholder="Name Surname" @bind-Value="@_creditCard.CardOwnerName"/>
                                </div>
                                <div class="form__group">

                                    <label >Card Number</label>
                                    <InputText type="text" maxlength="16" minlength="16" @bind-Value="@_creditCard.CardNumber" placeholder="1234 1234 1234 1234"/>
                                </div>
                                <div class="form__inputs">
                                    <div class="form__group form__group_half">

                                        <label >Expiry Date(MM)</label>
                                        <InputNumber @bind-Value="@_creditCard.ExpiryMonth" type="number" placeholder="MM"/>
                                    </div>
                                    <div class="form__group form__group_half">
                                        <label class="hide">Expiry Date(YY)</label>
                                        <InputNumber @bind-Value="@_creditCard.ExpiryYear" type="number" placeholder="YY"/>
                                    </div>
                                </div>
                                <div class="form__group">

                                    <label >Card Security Code</label>
                                    <InputNumber @bind-Value="@_creditCard.Cvv" type="number" minlength="3" maxlength="3" placeholder="123"/>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>


            </WizardStep>
        </Wizard>
    </div>
</section>

@code
{
    private User _user = new User();
    private Event _event = new Event();
    private BookTicketDTO _ticketDto = new BookTicketDTO();
    private CreditCard _creditCard = new CreditCard();
    private List<CreditCard> _rememberedCreditCards = null;
    
    [Parameter]
    public long eventId { get; set; }

    private void ChangeCreditCard(ChangeEventArgs args)
    {
        _creditCard = _rememberedCreditCards.Find(c => c.CardNumber == args.Value?.ToString());
        Console.WriteLine("###################");
        StateHasChanged();
        
    }

    private void IncrementCount()
    {
        _ticketDto.nrOfTickets++;
        StateHasChanged();
    }

    private void DecrementCount()
    {
        if (_ticketDto.nrOfTickets != 0)
            _ticketDto.nrOfTickets--;
        StateHasChanged();
    }

    private double TotalPrice()
    {
        return _event.Price * _ticketDto.nrOfTickets;
    }

    protected override async Task OnInitializedAsync()
    {
        _event = await _eventService.GetEventByIdAsync(eventId);

        var authState = ((CustomAuthenticationStateProvider) _authenticationStateProvider);
        _ticketDto.BuyerId = authState.LoggedInUser.Id;
        _ticketDto.EventId = _event.Id;

        _rememberedCreditCards = await _creditCardService.GetCreditCardsForUserAsync(authState.LoggedInUser.Id);
    }

    private async void Submit()
    {
        try
        {
            if (_creditCard.OwnerId == null) // if the owner id is null
            {
                _creditCard.OwnerId = ((CustomAuthenticationStateProvider) _authenticationStateProvider).LoggedInUser.Id;
                _creditCard = await _creditCardService.AddCreditCardAsync(_creditCard); // make sure owner id is initialized
            }
    //TODO Add payment
            Console.WriteLine("Ticket DTO: " + _ticketDto.nrOfTickets);

            var ticket = await _ticketService.BookTicketAsync(_ticketDto);

            MakePaymentDTO makePaymentDto = new MakePaymentDTO()
            {
                Buyer = _creditCard.OwnerId ?? throw new ArgumentException("Owner ID is null"),
                CreditCardNumber = _creditCard.CardNumber,
                Event = eventId
            };

            await _paymentService.MakePaymentAsync(makePaymentDto);


            _navigationManager.NavigateTo("/thank-you");
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }
}